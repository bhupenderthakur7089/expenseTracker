<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="main.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
    <title>Expense Tracker</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <h3 class="navbar-brand">Expense Tracker App</h3>
        </div>
        <ul class="navbar-nav">
            <li class="nav-item">
                <a href="expenseTracker.html" class="nav-link" id="selected">Home</a>
            </li>
            <li class="nav-item">
                <a href="login.html" class="nav-link"
                    onclick="alert('You have been Logged Out successfully')">Logout</a>
            </li>
            <li class="nav-item">
                <a href="signUp.html" class="nav-link">Sign Up</a>
            </li>
        </ul>
    </nav>

    <div class="container mt-5">
        <h5 class="text-center">Daily Expense Form</h5>
        <div id="msg"></div>
        <div class="row">
            <div class="col"></div>
            <div class="col-6 bg-danger-subtle rounded-4 p-4">
                <form id="myForm">
                    <label for="amount" class="form-label m">Expense Amount</label>
                    <div class="input-group">
                        <div class="input-group-text mb-3">$</div>
                        <input type="number" class="form-control mb-3" name="amount" id="amount" placeholder="10000"
                            required>
                    </div>
                    <div class="form-floating">
                        <input type="text" class="form-control mb-3" name="description" id="description"
                            placeholder="for fuel" required>
                        <label for="description" class="form-label">Description for the Expense</label>
                    </div>
                    <label for="category" class="form-label">Category</label>
                    <select name="category" id="category" class="form-select mb-3" required>
                        <option value="fuel">Fuel</option>
                        <option value="Grocery">Grocery</option>
                        <option value="Shopping">Online Shopping</option>
                        <option value="Internet Bill">Bill</option>
                        <option value="Others">Market</option>
                    </select>
                    <input type="submit" class="form-control" id="submitbtn" value="Add Expense">
                    <input type="button" class="form-control mt-2" onclick="buyPremium()" id="premiumBtn"
                        value="Buy Premium">
                    <div id="message"></div>
                    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

                </form>
            </div>
            <div class="col"></div>

        </div>
    </div>

    <h1>Expenses</h1>
    <ul id="items" class="list-group">

    </ul>
    <ul id="leaderboard"></ul>

    <script src="axios.min.js"></script>
    <script>
        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

        function showPremiumuserMessage() {
            document.getElementById('premiumBtn').style.visibility = "hidden"
            document.getElementById('message').innerHTML = "You are a premium user "
        }

        function showLeaderboard() {
            const inputElement = document.createElement("input");
            inputElement.type = "button";
            inputElement.value = 'Show Leaderboard';
            inputElement.onclick = () => {
                const token = localStorage.getItem('token');
                console.log('this is token: ' + token)
                axios
                    .get('http://localhost:3000/showLeaderBoard', { headers: { "authorization": token } })
                    .then((res) => {
                        console.log(res);
                        let leaderboardElem = document.getElementById('leaderboard')
                        leaderboardElem.innerHTML += '<h1> Leader Board </<h1>'
                        res.data.forEach((userDetails) => {
                            leaderboardElem.innerHTML += `<li>Name - ${userDetails.user.name}, Total Expense - ${userDetails.totalAmount || 0} </li>`
                        })
                    })
                    .catch((err) => console.log(err));

            }
            document.getElementById("message").appendChild(inputElement);
        }

        function buyPremium() {
            const token = localStorage.getItem('token');
            // console.log(token);
            axios
                .get("http://localhost:3000/buyPremium", { headers: { "authorization": token } })
                .then(res => {
                    var options = {
                        "key": res.data.key_id,
                        "order_id": res.data.order.id,
                        "handler": function (res) {
                            axios
                                .post('http://localhost:3000/updatetransactionstatus', { order_id: options.order_id, payment_id: res.razorpay_payment_id }, { headers: { "authorization": token } })
                                .then((res) => {
                                    console.log(res);
                                    alert('You are a Premium User Now');
                                    document.getElementById('premiumBtn').style.visibility = "hidden";
                                    document.getElementById('message').innerHTML = "You are a premium user ";
                                    localStorage.setItem('token', res.data.token);
                                    showLeaderboard();
                                })
                        },
                    };
                    const rzp1 = new Razorpay(options);
                    rzp1.open();
                    // e.preventDefault();

                    rzp1.on('payment.failed', function (response) {
                        console.log(response)
                        alert('Something went wrong')
                    });
                });
        }


        function displayExpense(expense) {
            let items = document.querySelector('#items');
            let list = document.createElement('li');
            list.name = expense.id;
            list.classList = 'list-group-item';
            list.textContent = expense.amount + '-' + expense.description + '-' + expense.category;

            let deleteBtn = document.createElement('input');
            deleteBtn.type = 'button';
            deleteBtn.name = 'Delete';
            deleteBtn.classList = 'btn btn-outline-dark btn-inline btn-sm';
            deleteBtn.value = 'Delete Expense';
            deleteBtn.onclick = function () { deleteList(this); };
            // let editBtn = document.createElement('input');
            // editBtn.type = 'button';
            // editBtn.name = 'Edit';
            // editBtn.classList = 'btn btn-outline-dark btn-inline btn-sm';
            // editBtn.value = 'Edit Expense';
            // editBtn.onclick = function () { editList(this); };

            let btnUlist = document.createElement('ul');
            btnUlist.classList = 'list-inline';
            let btnList = document.createElement('li');
            btnList.classList = 'list-inline-item';
            btnList.appendChild(deleteBtn);
            // btnList.appendChild(editBtn);
            btnUlist.appendChild(btnList);

            list.appendChild(btnUlist);
            items.appendChild(list);
        }

        function deleteList(deleteBtn) {
            let items = deleteBtn.parentElement.parentElement.parentElement.parentElement;
            let list = deleteBtn.parentElement.parentElement.parentElement;
            listName = list.name;
            axios.get(`http://localhost:3000/deleteExpense/${listName}`)
                .then(res => {
                    items.removeChild(list);
                })
            items.removeChild(list);
        }

        let form = document.querySelector('#myForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            amount = e.target.amount.value;
            description = e.target.description.value;
            category = e.target.category.value;
            let expense = {
                amount,
                description,
                category
            }
            const token = localStorage.getItem('token');
            axios
                .post("http://localhost:3000/addExpense", expense, { headers: { "authorization": token } })
                .then(res => {
                    console.log(res.data);
                    displayExpense(res.data);
                });

        });

        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const decodeToken = parseJwt(token);
            console.log(decodeToken);
            const ispremiumuser = decodeToken.ispremiumuser;
            if (ispremiumuser) {
                showPremiumuserMessage();
                showLeaderboard();
            }
            axios
                .get("http://localhost:3000/expenses", { headers: { "authorization": token } })
                .then(res => {
                    for (let i = 0; i < res.data.length; i++) {
                        displayExpense(res.data[i]);
                    }
                })
        })



        // function editList(editBtn) {
        //     let form = document.querySelector('#myForm');
        //     let items = editBtn.parentElement.parentElement.parentElement.parentElement;
        //     let list = editBtn.parentElement.parentElement.parentElement;
        //     listName = list.name;
        //     axios.get(`http://localhost:3000/editExpense/${listName}`)
        //         .then(res => {
        //             items.removeChild(list);
        //             form.amount.value = res.data.amount;
        //             form.description.value = res.data.description;
        //             form.category.value = res.data.category;
        //         })
        // }
    </script>
    </div>
</body>

</html>